<html>
<meta charset="utf-8">
<head>
<link href="../c3/c3.css" rel="stylesheet" type="text/css">

<script src="../d3/d3.min.js" charset="utf-8"></script>
<script src="../c3/c3.min.js"></script>

<style type="text/css">
/* @import url('opensanscondensed/OpenSans-CondBold.ttf');
@import url('opensanscondensed/OpenSans-CondBoldLight.ttf'); */

@font-face {
	font-family: "ptsr";
	font-style: normal;
	src: local("ptsr"), url("ptsansnarrow/PT_Sans-Narrow-Web-Regular.ttf") format("truetype");
}

@font-face {
	font-family: "ptsb";
	font-style: normal;
	src: local("ptsb"), url("ptsansnarrow/PT_Sans-Narrow-Web-Bold.ttf") format("truetype");
}

.legende {
	position: absolute;
	left: 25px;
	top: 15px;
	font-family: 'ptsr', sans;
	font-size: 28px;
}
.diagramm {
	position: absolute;
	left: 0px;
	top: 50px;
}
.temperatur {
	font-family: 'ptsb', sans;
	font-size: 28px;
}
.eintrag {
	font-family: 'ptsr', sans;
	font-size: 28px;
	text-decoration: none;
	padding-left: 5px;
}

.innen {
	color: #1F77B4;
}

.aussen {
	color: #FF7F0E;
}

.abgeschaltet {
	color: grey;
}

.c3-line {
	stroke-width: 1.5px;
}
</style>

</head>

<body style="font-family: 'ptsr', sans;">
	<div class="legende">
		Temperatur 
		<a class="eintrag innen" id="legendeInnen" data-id="innen" href="#">Innen</a> 
		<span class="temperatur innen" id="innen">°C</span> 
		<a class="eintrag aussen" id="legendeAussen" data-id="aussen" href="#">Außen</a> 
		<span class="temperatur aussen" id="aussen">°C</span> 
		<!-- Bereich: <a id="wertebereich" onclick="wertebereich();" href="#">(alles)</a> --> 
	</div>
	<div id="chart" class="diagramm"></div>

<script>
var schalterInnen = true;
var schalterAussen = true;
var bereich = -10;

var chart = c3.generate({
	padding: {
        	top: 0,
        	right: 70,
        	bottom: 0,
        	left: 70
    	},
	size: {
        	height: 600
       	 	// width: 1000 
    	},
	data: {
        	url: 'tm_720.csv',
        		// TODO  add support for "tm_sum.csv"
        	// type: 'area' 
		type: 'line', 
		// type: 'spline'
		x: 'datum',
		x_format: '%Y-%m-%d %H:%M:%S',
		labels: {
			// format: function (v, id) { if (v > 25000) return v / 1000; }
			/*
			format: {
                		y: function (v, id) { console.log (); if (v > 100) return id;  }
            		}
			*/
		},
	},
	legend: {
        	// position: 'top'
		show: false
    	},
	/*
	subchart: {
		show: true
	}
	*/
	point: {
		show: false
	},
	axis: {
		x: {
			type: 'timeseries',
			localtime: true,
			show: true,
			label: {
				text: 'Datum, Uhrzeit',
				position: 'outer-center'
			},
			tick: {
				fit: true,
				format: '%d.%m %H:%M', // %a, %d. %b "Sat, 30. Aug"
				count: 2,
				rotate: 65
			},
			height: 130,
			width: 70
			// padding: 15,
			// margin: 15
		},
		y: {
			show: true,
			label: {
				text: 'Temperatur in °C',
				position: 'outer-middle'
			},
			tick: {
				format: function(t) { return t / 1000; }
			}
		}
	},
	grid: {
        	x: {
            		show: false
        	},
        	y: {
            		show: true
        	}
    }
});

setInterval(function () {
    	chart.load({
        	url: 'tm_720.csv'
        		// TODO  add support for "tm_sum.csv"
   	});
	aktualisiere();
}, 60000);

function aktualisiere() {
	i = chart.data.xs.innen.length;
	// console.log('i = ' + i);
	// console.log(chart.data.targets[0].values[i - 1]);
	d3.select('#innen').text((chart.data.targets[0].values[i - 1].value / 1000).toFixed(1) + '°C');
	d3.select('#aussen').text((chart.data.targets[1].values[i - 1].value / 1000).toFixed(1) + '°C');
	aktualisiereAxis();
}

setTimeout(function () {
	/*
	chart.load({
            	url: 'ttest.csv'
        });
	*/
	d3.select('#wertebereich').text(Math.ceil(chart.data.xs.innen.length / 60) + 'h (alles)');
	aktualisiere();
}, 1000);

function aktualisiereAxis() {
	var valuesBereichInnen = chart.data.targets[0].values;

	// debug
	// console.log(valuesBereichInnen.length);

	var valuesBereichAussen = chart.data.targets[1].values;
	if (d3.select('#wertebereich').text() == '12h') {
		valuesBereichInnen = chart.data.targets[0].values.slice(bereich);
		valuesBereichAussen = chart.data.targets[1].values.slice(bereich);
	}
    var maxValueInnen = d3.max(valuesBereichInnen, function (o) { return o.value; }) + 1000;
	var maxValueAussen = d3.max(valuesBereichAussen, function (o) { return o.value; }) + 1000;
	var minValueInnen = d3.min(valuesBereichInnen, function (o) { return o.value; }) - 1000;
	var minValueAussen = d3.min(valuesBereichAussen, function (o) { return o.value; }) - 1000;

	// debug
	// console.log('maxValueInnen = ' + maxValueInnen);
	// console.log('maxValueAussen = ' + maxValueAussen);
	// console.log('minValueInnen = ' + minValueInnen);
	// console.log('minValueAussen = ' + minValueAussen);

	if (schalterAussen && schalterInnen) {
		if (maxValueInnen > maxValueAussen) {
			chart.axis.max({y: maxValueInnen});
		} else {
			chart.axis.max({y: maxValueAussen});
		}
		if (minValueInnen < minValueAussen) {
			chart.axis.min({y: minValueInnen});
		} else {
			chart.axis.min({y: minValueAussen});
		}
	} else if (!schalterInnen) {
		chart.axis.max({y: maxValueAussen});
		chart.axis.min({y: minValueAussen});
	} else if (!schalterAussen) {
		chart.axis.max({y: maxValueInnen});
		chart.axis.min({y: minValueInnen});
	}
}

function wertebereich() {
	// console.log ('anzahl = '+ chart.data.xs.innen.length);	
	if (d3.select('#wertebereich').text() == '12h') {
		d3.select('#wertebereich').text(Math.ceil(chart.data.xs.innen.length / 60) + 'h (alles)');

		// chart.axis.min({x: function(d) { console.log(d); } });
		chart.axis.min({x: 0});
	} else {
		d3.select('#wertebereich').text('12h');
		// chart.axis.min({x: chart.data.xs.innen.length - bereich});
		chart.axis.min({x: new Date('2014-07-19')});
		
	}
	aktualisiere();
}

function toggle(l) {
	chart.toggle(l);
	if (l == 'innen') {
		schalterInnen = !schalterInnen;
	} else {
		schalterAussen = !schalterAussen;
	}
	// aktualisiereAxis();
}

d3.selectAll('.legende a')
.on('mouseover', function () {
    var id = d3.select(this).attr('data-id');
    chart.focus(id);
})
.on('mouseout', function () {
    var id = d3.select(this).attr('data-id');
    chart.revert();
})
.on('click', function () {
    var id = d3.select(this).attr('data-id');
    chart.toggle(id);
    if (id == 'innen') {
    	schalterInnen = !schalterInnen;
    	if (!schalterInnen) {
			d3.selectAll('.innen').classed({'abgeschaltet': true});
		} else {
			d3.selectAll('.innen').classed({'abgeschaltet': false});
		}
    } else {
    	// debug
    	// console.log('aussen geklickt');
    	// console.log('selektion = ' + d3.select('#legendeAussen').size());
    
    	schalterAussen = !schalterAussen;
    	if (!schalterAussen) {
    		// console.log('aussen aus');
    		
			d3.selectAll('.aussen').classed({'abgeschaltet': true});
		} else {
			// console.log('aussen ein');
		
			d3.selectAll('.aussen').classed({'abgeschaltet': false});
		}
		
		// console.log('klassen = ' + d3.select('#legendeAussen').attr('class'));
    }
    
});

</script>

</body>

</html>
